import { URL } from "node:url";
async function readBody(req) {
    const chunks = [];
    for await (const chunk of req) {
        chunks.push(typeof chunk === "string" ? Buffer.from(chunk) : chunk);
    }
    return Buffer.concat(chunks).toString("utf-8");
}
function wrapResponse(res) {
    const self = {
        status(code) { res.statusCode = code; return self; },
        json(data) { res.setHeader("Content-Type", "application/json"); res.end(JSON.stringify(data)); return self; },
        send(data) { typeof data === "string" ? res.end(data) : self.json(data); return self; },
        end() { res.end(); return self; },
        setHeader(name, value) { res.setHeader(name, value); return self; },
        get headersSent() { return res.headersSent; },
    };
    return self;
}
export function adaptRoute(route, bridge) {
    if (!route.handler)
        return null;
    const adaptedPath = `/eliza${route.path.startsWith("/") ? route.path : `/${route.path}`}`;
    const routeHandler = route.handler;
    return {
        path: adaptedPath,
        async handler(req, res) {
            const urlObj = new URL(req.url ?? "/", `http://${req.headers.host ?? "localhost"}`);
            const parsedQuery = {};
            for (const [key, value] of urlObj.searchParams.entries()) {
                const existing = parsedQuery[key];
                parsedQuery[key] = existing
                    ? Array.isArray(existing) ? [...existing, value] : [existing, value]
                    : value;
            }
            let parsedBody;
            const method = (req.method ?? "GET").toUpperCase();
            if (method === "POST" || method === "PUT" || method === "PATCH") {
                const raw = await readBody(req);
                if (raw.length > 0) {
                    try {
                        parsedBody = JSON.parse(raw);
                    }
                    catch {
                        parsedBody = { _raw: raw, _parseError: true };
                    }
                }
            }
            await routeHandler({ body: parsedBody, params: {}, query: parsedQuery, headers: req.headers, method: req.method ?? "GET", path: req.url ?? "/", url: req.url ?? "/" }, wrapResponse(res), bridge);
        },
    };
}
//# sourceMappingURL=route-adapter.js.map